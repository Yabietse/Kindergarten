<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>የሙዚቃ ትምህርት ደረጃዎች ጥያቄና መልስ</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a better look and feel */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Ensure it takes full viewport height */
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); /* Soft shadow */
            padding: 2.5rem;
            max-width: 600px;
            width: 100%;
            text-align: center;
        }
        .list-item, .button {
            transition: all 0.2s ease-in-out; /* Smooth transitions for hover effects */
        }
        .list-item:hover {
            transform: translateY(-3px); /* Slight lift on hover */
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }
        /* Custom modal for alerts */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .option-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border: 1px solid #cbd5e0; /* Light gray border */
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            background-color: #f8fafc; /* Very light blue-gray */
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            text-align: left;
        }
        .option-item:hover {
            background-color: #e2e8f0; /* Slightly darker on hover */
            border-color: #93c5fd; /* Blue border on hover */
        }
        .option-item input[type="radio"] {
            margin-right: 1rem;
            cursor: pointer;
            accent-color: #3b82f6; /* Blue accent for radio button */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">የሙዚቃ ትምህርት ደረጃዎች</h1>

        <!-- Level List Section -->
        <div id="level-list" class="space-y-4">
            <!-- List items will be dynamically inserted here by JavaScript -->
        </div>

        <!-- Quiz Section (initially hidden) -->
        <div id="quiz-section" class="hidden text-left">
            <button id="back-button" class="button bg-gray-200 text-gray-700 px-4 py-2 rounded-lg mb-6 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75">
                ← ወደ ደረጃዎች ተመለስ
            </button>
            <p id="level-title" class="text-2xl font-semibold text-blue-700 mb-6"></p>
            <p id="question-number" class="text-lg text-gray-600 mb-2"></p>
            <p id="question-display" class="text-xl text-gray-800 mb-6"></p>

            <!-- Options container for multiple choice -->
            <div id="options-container" class="space-y-3 mb-4">
                <!-- Multiple choice options will be inserted here by JavaScript -->
            </div>

            <button id="submit-answer" class="button bg-blue-600 text-white px-6 py-3 rounded-lg w-full hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                መልስ አስገባ
            </button>
            <button id="next-question" class="button bg-green-500 text-white px-6 py-3 rounded-lg w-full mt-4 hidden hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
                ቀጣይ ጥያቄ
            </button>
            <p id="feedback-display" class="text-lg mt-4 font-medium"></p>
            <p id="quiz-complete-message" class="text-2xl text-green-700 font-bold mt-8 hidden">
                ጥያቄዎቹ ተጠናቀዋል! በጣም ጥሩ!
            </p>
        </div>
    </div>

    <!-- Custom Modal for Messages -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p id="modal-message" class="text-lg text-gray-800"></p>
            <button id="modal-ok-button" class="button bg-blue-600 text-white px-4 py-2 rounded-lg mt-4 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">እሺ</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration and initialization (MANDATORY in Canvas, optional for local run without persistence)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Use a dummy for local execution
        const firebaseConfigRaw = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        let firebaseConfig = {};
        let firebaseEnabled = false;

        // Attempt to parse firebaseConfig. If it's an empty object, Firebase will not be initialized.
        try {
            firebaseConfig = JSON.parse(firebaseConfigRaw);
            // Check if the parsed config actually has keys (meaning it's not just an empty object from Canvas default)
            if (Object.keys(firebaseConfig).length > 0) {
                firebaseEnabled = true;
            } else {
                console.warn("No Firebase configuration provided or config is empty. Persistence will be disabled.");
            }
        } catch (e) {
            console.error("Error parsing Firebase config:", e);
            console.warn("Firebase will be disabled due to config error. Persistence will not work.");
        }

        let app, db, auth, userId;
        let firebaseInitialized = false; // Flag to track successful Firebase initialization

        // Function to show custom modal
        function showModal(message) {
            const modal = document.getElementById('myModal');
            const modalMessage = document.getElementById('modal-message');
            modalMessage.textContent = message;
            modal.style.display = 'flex'; // Use flex to center
        }

        // Helper function to shuffle an array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Firestore: Save user's last selected level and question index
        async function saveUserProgress(uid, levelId, questionIndex) {
            if (!firebaseInitialized || !db) { // Check firebaseInitialized
                console.warn("Firebase is not initialized. Progress will not be saved.");
                return;
            }
            const userDocRef = doc(db, `artifacts/${appId}/users/${uid}/progress`, 'lastQuizState');
            try {
                await setDoc(userDocRef, {
                    lastLevelId: levelId,
                    lastQuestionIndex: questionIndex
                }, { merge: true });
                console.log(`User ${uid} progress saved: Level ${levelId}, Question ${questionIndex}`);
            } catch (e) {
                console.error("Error saving document: ", e);
                showModal("ሂደትን ማስቀመጥ አልተቻለም፡፡ እባክዎ የበይነመረብ ግንኙነትዎን ያረጋግጡ።");
            }
        }

        // Firestore: Load user's last selected level and question index and resume
        async function loadUserProgress(uid) {
            if (!firebaseInitialized || !db) { // Check firebaseInitialized
                console.warn("Firebase is not initialized. Progress will not be loaded.");
                return;
            }
            const userDocRef = doc(db, `artifacts/${appId}/users/${uid}/progress`, 'lastQuizState');
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const lastLevelId = data.lastLevelId;
                    const lastQuestionIndex = data.lastQuestionIndex || 0; // Default to 0 if not set

                    const lastLevel = levels.find(level => level.id === lastLevelId);
                    if (lastLevel) {
                        // Check if the saved index is within bounds of the current questions for that level
                        const effectiveIndex = Math.min(lastQuestionIndex, lastLevel.questions.length);
                        if (effectiveIndex < lastLevel.questions.length) {
                            showModal(`እንኳን ደህና መጡ! የ${lastLevel.name} ጥያቄ ${effectiveIndex + 1} ከቀጠሉበት ይቀጥሉ።`);
                            showQuiz(lastLevel, effectiveIndex);
                        } else {
                            // If saved index is past the end, start at beginning of that level
                            showModal(`እንኳን ደህና መጡ! የ${lastLevel.name} ጥያቄዎችን አጠናቅቀዋል። እንደገና እንጀምር።`);
                            showQuiz(lastLevel, 0);
                        }
                        console.log(`User ${uid} last quiz state loaded: Level ${lastLevelId}, Question ${effectiveIndex}`);
                    }
                }
            } catch (e) {
                console.error("Error loading document: ", e);
                showModal("የቀደመውን ሂደት መጫን አልተቻለም።");
            }
        }


        // Get modal elements
        const modal = document.getElementById('myModal');
        const closeButton = document.querySelector('.close-button');
        const modalOkButton = document.getElementById('modal-ok-button');

        // Close modal when close button is clicked
        closeButton.onclick = function() {
            modal.style.display = 'none';
        }

        // Close modal when OK button is clicked
        modalOkButton.onclick = function() {
            modal.style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            if (firebaseEnabled) {
                try {
                    // Initialize Firebase
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // Sign in anonymously or with custom token (MANDATORY for persistence)
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    // Get the user ID after authentication
                    userId = auth.currentUser?.uid || crypto.randomUUID();
                    console.log("Firebase initialized. User ID:", userId);
                    firebaseInitialized = true; // Set flag to true on success

                } catch (error) {
                    console.error("Error initializing Firebase services:", error);
                    showModal("የFirebase አገልግሎቶችን ማስጀመር አልተሳካም። መተግበሪያው ያለ ሂደት ማስቀመጥ ይሰራል። ቋሚነትን ማንቃት ከፈለጉ፣ የFirebase ፕሮጀክትዎ በትክክል መዋቀሩን ያረጋግጡ።");
                    firebaseInitialized = false; // Ensure flag is false on error
                }
            } else {
                console.log("Firebase is not enabled (no configuration found). The app will run without saving/loading progress.");
            }

            // Always initialize the app logic, regardless of Firebase status
            initApp();

            // Load user progress ONLY if Firebase was successfully initialized
            if (firebaseInitialized) {
                loadUserProgress(userId);
            }
        });

        function initApp() {
            // Data structure for levels and questions
            const levels = [
                {
                    name: "የመዋዕለ ሕፃናት ሙዚቃ",
                    id: "kindergarten_music",
                    questions: [
                        { question: "የትኛው መሳሪያ ነው የሚነፋው?", options: ["ፒያኖ", "ከበሮ", "ዋሽንት", "ጊታር"], answer: "ዋሽንት" },
                        { question: "የሙዚቃ ማቆሚያ ምልክት ምንድነው?", options: ["ነጥብ", "ኮማ", "እረፍት", "ጥያቄ ምልክት"], answer: "እረፍት" },
                        { question: "ዘፈን ስንዘምር ምን አይነት ድምፅ እናወጣለን?", options: ["ጩኸት", "ሳቅ", "ዜማ", "ጸጥታ"], answer: "ዜማ" },
                        { question: "ፒያኖ ስንት ጥቁር ቁልፎች አሉት? (በአንድ ኦክታቭ)", options: ["3", "4", "5", "6"], answer: "5" },
                        { question: "ጊታር ስንት ገመዶች አሉት?", options: ["4", "5", "6", "7"], answer: "6" },
                        { question: "የልጆች ተወዳጅ የሙዚቃ መሳሪያ የትኛው ነው?", options: ["ሳክስፎን", "ቫዮሊን", "ማራካስ", "ኦርኬስትራ"], answer: "ማራካስ" },
                        { question: "ከበሮ ለመጫወት ምን እንጠቀማለን?", options: ["እግር", "እጅ", "አፍ", "ዓይን"], answer: "እጅ" },
                        { question: "የ'ዶ ሬ ሚ' ቅደም ተከተል ምን ይባላል?", options: ["ፊደላት", "ቁጥሮች", "የሙዚቃ ሚዛን", "ምልክቶች"], answer: "የሙዚቃ ሚዛን" },
                        { question: "የየትኛው እንስሳ ድምፅ ዘፈን ይመስላል?", options: ["አንበሳ", "ወፍ", "ድመት", "ውሻ"], answer: "ወፍ" },
                        { question: "ሙዚቃ ለምን ይጠቅማል?", options: ["ለመደነስ", "ለማንበብ", "ለመስማት", "ሁሉንም"], answer: "ሁሉንም" }
                    ]
                },
                {
                    name: "የ KG 1 ሙዚቃ",
                    id: "kg1_music",
                    questions: [
                        { question: "ከሚከተሉት ውስጥ የብራስ መሳሪያ የትኛው ነው?", options: ["ክላርኔት", "ትራምፔት", "ፍሉጥ", "ቫዮሊን"], answer: "ትራምፔት" },
                        { question: "የሙዚቃ ድምፅን ከፍ ወይም ዝቅ ለማድረግ ምን እንጠቀማለን?", options: ["ሪትም", "ፒች", "ቴምፖ", "ሜሎዲ"], answer: "ፒች" },
                        { question: "ታዋቂ የኢትዮጵያ ባህላዊ የሙዚቃ መሳሪያ የትኛው ነው?", options: ["ፒያኖ", "ክራር", "ጊታር", "ቫዮሊን"], answer: "ክራር" },
                        { question: "የሙዚቃ ፍጥነት ምን ይባላል?", options: ["ሪትም", "ፒች", "ቴምፖ", "ቶን"], answer: "ቴምፖ" },
                        { question: "ከሚከተሉት የሙዚቃ ዘውጎች ውስጥ ለዳንስ የሚያገለግለው የትኛው ነው?", options: ["ክላሲካል", "ብሉዝ", "ሂፕ ሆፕ", "ጃዝ"], answer: "ሂፕ ሆፕ" },
                        { question: "የሙዚቃ ኖቶች ስንት ዋና ቅርጾች አሏቸው?", options: ["4", "5", "6", "7"], answer: "7" },
                        { question: "የሙዚቃን ታሪክ የሚያጠና ሰው ምን ይባላል?", options: ["ሙዚቀኛ", "አርቲስት", "ሙዚኮሎጂስት", "የዘፈን ደራሲ"], answer: "ሙዚኮሎጂስት" },
                        { question: "ኦርኬስትራ በብዛት ምን አይነት መሳሪያዎችን ያካትታል?", options: ["ከበሮ", "የቁልፍ ሰሌዳ", "የነፋስ፣ የክር፣ የመምታት", "ጊታር ብቻ"], answer: "የነፋስ፣ የክር፣ የመምታት" },
                        { question: "የሙዚቃ ግጥም ማን ይጽፋል?", options: ["አቀናባሪ", "ዘፋኝ", "የግጥም ደራሲ", "አድማጭ"], answer: "የግጥም ደራሲ" },
                        { question: "የሙዚቃን መውጣትና መውረድ ምን ይባላል?", options: ["ሪትም", "ዜማ", "ድምፅ", "ሃርሞኒ"], answer: "ዜማ" }
                    ]
                },
                {
                    name: "የ KG 2 ሙዚቃ",
                    id: "kg2_music",
                    questions: [
                        { question: "የ'ትሬብል ክሌፍ' ምልክት ለየትኛው የሙዚቃ መሳሪያ ይበልጥ ይጠቅማል?", options: ["ባስ ጊታር", "ሴሎ", "ፒያኖ ቀኝ እጅ", "ከበሮ"], answer: "ፒያኖ ቀኝ እጅ" },
                        { question: "'ፎርቴ' በሙዚቃ ውስጥ ምን ማለት ነው?", options: ["ቀርፋፋ", "ፈጣን", "ጮክ ያለ", "ዝም ያለ"], answer: "ጮክ ያለ" },
                        { question: "የሙዚቃ ሪትም ምንን ይገልጻል?", options: ["የሙዚቃን ስሜት", "የድምፅ ቅደም ተከተል", "የድምፅ ከፍታ", "የመሳሪያ አይነት"], answer: "የድምፅ ቅደም ተከተል" },
                        { question: "የሙዚቃ ስብስብ 'ኳርቴት' ሲባል ስንት ሙዚቀኞች ማለት ነው?", options: ["2", "3", "4", "5"], answer: "4" },
                        { question: "ታዋቂውን 'ሲምፎኒ ቁጥር 5' ማን አቀናበረው?", options: ["ሞዛርት", "ቤትሆቨን", "ባች", "ቾፒን"], answer: "ቤትሆቨን" },
                        { question: "የሙዚቃ ቅንብር ክፍሎች እንዴት ይከፋፈላሉ?", options: ["ቃላት", "ምዕራፎች", "እንቅስቃሴዎች", "ቁጥሮች"], answer: "እንቅስቃሴዎች" },
                        { question: "የሙዚቃ መሳሪያዎችን የሚያስተካክል ሰው ምን ይባላል?", options: ["ሙዚቀኛ", "መካኒክ", "튜ነር", "ኦርኬስትራ"], answer: "튜ነር" },
                        { question: "'ሌጋቶ' በሙዚቃ ውስጥ ምን ማለት ነው?", options: ["በፍጥነት መጫወት", "በዝግታ መጫወት", "ድምፆችን በማያቋርጥ ሁኔታ ማገናኘት", "ድምፆችን መለየት"], answer: "ድምፆችን በማያቋርጥ ሁኔታ ማገናኘት" },
                        { question: "የየትኛው የሙዚቃ ዘውግ መነሻው አፍሪካ-አሜሪካውያን መንፈሳዊ ዘፈኖች ናቸው?", options: ["ሮክ", "ፖፕ", "ጎስፔል", "ክላሲካል"], answer: "ጎስፔል" },
                        { question: "በሙዚቃ ውስጥ 'ክሬስሴንዶ' ማለት ምን ማለት ነው?", options: ["ድምፅን መቀነስ", "ድምፅን መጨመር", "ፍጥነትን መቀነስ", "ፍጥነትን መጨመር"], answer: "ድምፅን መጨመር" }
                    ]
                },
                {
                    name: "የ KG 3 ሙዚቃ",
                    id: "kg3_music",
                    questions: [
                        { question: "የ'ባስ ክሌፍ' ምልክት በብዛት ለየትኛው የሙዚቃ መሳሪያ ይጠቅማል?", options: ["ቫዮሊን", "ፍሉጥ", "ሴሎ", "ፒያኖ ቀኝ እጅ"], answer: "ሴሎ" },
                        { question: "'ፒያኖ' በሙዚቃ ውስጥ ምን ማለት ነው?", options: ["ጮክ ያለ", "በጣም ጮክ ያለ", "ዝም ያለ", "በጣም ዝም ያለ"], answer: "ዝም ያለ" },
                        { question: "የሙዚቃ ድምፆች ስም በአማርኛ የትኞቹ ናቸው?", options: ["ዶ ሬ ሚ ፋ ሶ ላ ሲ", "አ ብ ሐ", "1 2 3", "ሀ ለ ሐ መ"], answer: "ዶ ሬ ሚ ፋ ሶ ላ ሲ" },
                        { question: "'ሶናታ' ምን አይነት የሙዚቃ ቅንብር ነው?", options: ["ዘፈን", "ትንሽ ቅንብር", "ለአንድ ወይም ለሁለት መሳሪያዎች የተጻፈ ትልቅ ቅንብር", "ዳንስ"], answer: "ለአንድ ወይም ለሁለት መሳሪያዎች የተጻፈ ትልቅ ቅንብር" },
                        { question: "የጃዝ ሙዚቃ የት ተጀመረ?", options: ["አውሮፓ", "አፍሪካ", "ኒው ኦርሊንስ", "እስያ"], answer: "ኒው ኦርሊንስ" },
                        { question: "በሙዚቃ ውስጥ 'አሌግሮ' ማለት ምን ማለት ነው?", options: ["ቀርፋፋ", "ፈጣን", "በዝግታ", "በጣም ፈጣን"], answer: "ፈጣን" },
                        { question: "የሙዚቃ ማስታወሻዎችን የሚቀዳ ሰው ምን ይባላል?", options: ["አቀናባሪ", "ዘፋኝ", "አዘጋጅ", "አድማጭ"], answer: "አቀናባሪ" },
                        { question: "'ስታካቶ' በሙዚቃ ውስጥ ምን ማለት ነው?", options: ["ድምፆችን ማገናኘት", "ድምፆችን በሹል መለየት", "ድምፅን መጨመር", "ድምፅን መቀነስ"], answer: "ድምፆችን በሹል መለየት" },
                        { question: "ከሚከተሉት የሙዚቃ ዘውጎች ውስጥ በአፍሪካዊያን መንፈሳዊ ሙዚቃ ላይ የተመሰረተው የትኛው ነው?", options: ["ሮክ ኤንድ ሮል", "ብሉዝ", "ፖፕ", "ክላሲካል"], answer: "ብሉዝ" },
                        { question: "በሙዚቃ ውስጥ 'ዲሚኑዌንዶ' ማለት ምን ማለት ነው?", options: ["ድምፅን መጨመር", "ድምፅን መቀነስ", "ፍጥነትን መጨመር", "ፍጥነትን መቀነስ"], answer: "ድምፅን መቀነስ" }
                    ]
                },
                {
                    name: "የ 1ኛ ክፍል ሙዚቃ",
                    id: "grade1_music",
                    questions: [
                        { question: "የትኛው የክር መሳሪያ ነው በብዛት የሚቀስትበት?", options: ["ጊታር", "መሰንቆ", "ፒያኖ", "ከበሮ"], answer: "መሰንቆ" },
                        { question: "'ፉርቴ' የሚለው የሙዚቃ ቃል ምንን ያመለክታል?", options: ["ዝግታ", "ፍጥነት", "ጥንካሬ", "ድክመት"], answer: "ጥንካሬ" },
                        { question: "የሙዚቃ መሳሪያዎችን የሚያስተባብር እና የሚመራ ሰው ምን ይባላል?", options: ["አቀናባሪ", "ዘፋኝ", "መሪ", "ሙዚቀኛ"], answer: "መሪ" },
                        { question: "ከሚከተሉት ውስጥ 'ፔርከሽንም' የሚያገለግለው የትኛው መሳሪያ ነው?", options: ["ፒያኖ", "ከበሮ", "ዋሽንት", "ቫዮሊን"], answer: "ከበሮ" },
                        { question: "የሙዚቃ ጊዜን የሚለካው ምንድን ነው?", options: ["ቴምፖ", "ሪትም", "ሜሎዲ", "ሃርሞኒ"], answer: "ሪትም" },
                        { question: "የሙዚቃ ድምፅ 'ከፍታ' ምን ይባላል?", options: ["ቴምፖ", "ፒች", "ቶን", "ሪትም"], answer: "ፒች" },
                        { question: "በሙዚቃ ውስጥ 'አክሰንት' ማለት ምን ማለት ነው?", options: ["የድምፅ መቀነስ", "የድምፅ መጨመር", "አንድን ኖት ጎላ አድርጎ መጫወት", "በዝግታ መጫወት"], answer: "አንድን ኖት ጎላ አድርጎ መጫወት" },
                        { question: "የትኛው የሙዚቃ ዘውግ ነው በብዛት 'ብቸኛ' ዘፋኝ የሚያስፈልገው?", options: ["ኦርኬስትራ", "ኮራል", "ሶሎ", "ባንድ"], answer: "ሶሎ" },
                        { question: "የሙዚቃ ድምፅ ባህሪ ምን ይባላል?", options: ["ሜሎዲ", "ሃርሞኒ", "ቲምበር", "ቴምፖ"], answer: "ቲምበር" },
                        { question: "የየትኛው ሀገር የሙዚቃ መሳሪያ 'ባላላይካ' ነው?", options: ["ኢትዮጵያ", "ሩሲያ", "ቻይና", "ህንድ"], answer: "ሩሲያ" }
                    ]
                },
                {
                    name: "የ 2ኛ ክፍል ሙዚቃ",
                    id: "grade2_music",
                    questions: [
                        { question: "የ'ሲምፎኒ' ቅንብር በአብዛኛው ስንት ክፍሎች አሉት?", options: ["2", "3", "4", "5"], answer: "4" },
                        { question: "'አዳጂዮ' በሙዚቃ ውስጥ ምን ማለት ነው?", options: ["በፍጥነት", "በጣም ቀርፋፋ", "በዝግታ", "በመጠኑ ፈጣን"], answer: "በጣም ቀርፋፋ" },
                        { question: "የሙዚቃ ኮርድ ስንት ኖቶች አሉት (ቢያንስ)?", options: ["1", "2", "3", "4"], answer: "3" },
                        { question: "የ'ሶፕራኖ' ድምፅ ምንድን ነው?", options: ["ዝቅተኛ የወንድ ድምፅ", "ከፍተኛ የሴት ድምፅ", "መካከለኛ የወንድ ድምፅ", "ዝቅተኛ የሴት ድምፅ"], answer: "ከፍተኛ የሴት ድምፅ" },
                        { question: "ታዋቂውን 'ኦፔራ ካርመን' ማን አቀናበረው?", options: ["ቨርዲ", "ፑቺኒ", "ቢዜት", "ዋግነር"], answer: "ቢዜት" },
                        { question: "የሙዚቃ ድምፅን ከፍታ የሚያሳይ መስመር ምን ይባላል?", options: ["ሪትም", "ስቴፍ", "ባር", "ክሌፍ"], answer: "ስቴፍ" },
                        { question: "የ'አርፔጂዮ' ቅንብር እንዴት ነው የሚጫወተው?", options: ["ኖቶችን በአንድነት", "ኖቶችን በቅደም ተከተል", "ኖቶችን በዝግታ", "ኖቶችን በፍጥነት"], answer: "ኖቶችን በቅደም ተከተል" },
                        { question: "የየትኛው የሙዚቃ ዘውግ መነሻው የአሜሪካ ደቡባዊ ክፍለ ሀገር ነው?", options: ["ሬጌ", "ጃዝ", "ካንትሪ", "ፖፕ"], answer: "ካንትሪ" },
                        { question: "በሙዚቃ ውስጥ 'ሊበርቶ' ምንን ያመለክታል?", options: ["የሙዚቃ መሳሪያ", "የኦፔራ ግጥም", "የዳንስ አይነት", "የዘፈን ዜማ"], answer: "የኦፔራ ግጥም" },
                        { question: "የሙዚቃን ስሜት የሚገልጸው የትኛው አካል ነው?", options: ["ቴምፖ", "ሪትም", "ዳይናሚክስ", "ፒች"], answer: "ዳይናሚክስ" }
                    ]
                },
                {
                    name: "የ 3ኛ ክፍል ሙዚቃ",
                    id: "grade3_music",
                    questions: [
                        { question: "የ'ግራንድ ስቴፍ' ምልክት ለየትኞቹ የሙዚቃ መሳሪያዎች ይበልጥ ጠቃሚ ነው?", options: ["ዋሽንት", "ከበሮ", "ፒያኖ", "ጊታር"], answer: "ፒያኖ" },
                        { question: "'ፕረስቲሲሞ' በሙዚቃ ውስጥ ምን ማለት ነው?", options: ["በጣም ቀርፋፋ", "በጣም ፈጣን", "በመጠኑ", "በዝግታ"], answer: "በጣም ፈጣን" },
                        { question: "በሙዚቃ ውስጥ 'ሞዱሌሽን' ምን ማለት ነው?", options: ["ቴምፖ መቀየር", "ሪትም መቀየር", "ከአንድ ቁልፍ ወደ ሌላ ቁልፍ መቀየር", "ድምፅ መቀነስ"], answer: "ከአንድ ቁልፍ ወደ ሌላ ቁልፍ መቀየር" },
                        { question: "የ'አልቶ' ድምፅ ምንድን ነው?", options: ["ከፍተኛ የወንድ ድምፅ", "መካከለኛ የሴት ድምፅ", "ዝቅተኛ የሴት ድምፅ", "መካከለኛ የወንድ ድምፅ"], answer: "መካከለኛ የሴት ድምፅ" },
                        { question: "የ'ባሮክ' የሙዚቃ ዘመን በየትኛው ክፍለ ዘመን ነበር?", options: ["14ኛ-15ኛ", "16ኛ-17ኛ", "17ኛ-18ኛ", "19ኛ-20ኛ"], answer: "17ኛ-18ኛ" },
                        { question: "የሙዚቃ 'ፎርም' ምንን ይገልጻል?", options: ["የሙዚቃውን ቅርፅ እና አደረጃጀት", "የሙዚቃ መሳሪያ አይነት", "የዘፋኝ ድምፅ", "የሙዚቃ ታሪክ"], answer: "የሙዚቃውን ቅርፅ እና አደረጃጀት" },
                        { question: "የ'ኦራቶሪዮ' ቅንብር ምንን ያካትታል?", options: ["ብቸኛ ዘፋኞች እና ኦርኬስትራ ያለ ድራማ", "ብቻ መሳሪያ ሙዚቃ", "ዳንስ ብቻ", "ትንሽ የዘፈን ስብስብ"], answer: "ብቸኛ ዘፋኞች እና ኦርኬስትራ ያለ ድራማ" },
                        { question: "የየትኛው የሙዚቃ ዘውግ ነው 'ሬጌ'?", options: ["ካንትሪ", "ጃዝ", "አፍሪካን", "ጃማይካን"], answer: "ጃማይካን" },
                        { question: "በሙዚቃ ውስጥ 'ኮንሰርቶ' ምን ማለት ነው?", options: ["ለብቸኛ መሳሪያ እና ኦርኬስትራ የተጻፈ ቅንብር", "ለድምፅ ብቻ የተጻፈ ቅንብር", "ለዳንስ ብቻ የተጻፈ ቅንብር", "ለከበሮ ብቻ የተጻፈ ቅንብር"], answer: "ለብቸኛ መሳሪያ እና ኦርኬስትራ የተጻፈ ቅንብር" },
                        { question: "የሙዚቃ 'ሜሎዲ' ምንን ይገልጻል?", options: ["የድምፆች ቅደም ተከተል", "የድምፆች ቅንጅት", "የድምፆች ጥንካሬ", "የሙዚቃ ፍጥነት"], answer: "የድምፆች ቅደም ተከተል" }
                    ]
                }
            ];

            // DOM elements
            const levelListDiv = document.getElementById('level-list');
            const quizSectionDiv = document.getElementById('quiz-section');
            const backButton = document.getElementById('back-button');
            const levelTitle = document.getElementById('level-title');
            const questionNumberDisplay = document.getElementById('question-number');
            const questionDisplay = document.getElementById('question-display');
            const optionsContainer = document.getElementById('options-container');
            const submitAnswerButton = document.getElementById('submit-answer');
            const nextQuestionButton = document.getElementById('next-question');
            const feedbackDisplay = document.getElementById('feedback-display');
            const quizCompleteMessage = document.getElementById('quiz-complete-message');

            let currentLevel = null;
            let currentQuestionIndex = 0;
            let selectedOption = null;

            // Function to render the list of levels
            function renderLevels() {
                levelListDiv.innerHTML = ''; // Clear previous list
                levels.forEach(level => {
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item bg-blue-100 text-blue-800 p-4 rounded-lg cursor-pointer text-xl font-medium shadow-md hover:bg-blue-200';
                    listItem.textContent = level.name;
                    listItem.dataset.levelId = level.id; // Store ID for easy lookup
                    listItem.addEventListener('click', () => showQuiz(level));
                    levelListDiv.appendChild(listItem);
                });
            }

            // Function to show the quiz section for a given level
            function showQuiz(level, startIndex = 0) {
                currentLevel = level;
                currentQuestionIndex = startIndex;
                levelListDiv.classList.add('hidden'); // Hide level list
                quizSectionDiv.classList.remove('hidden'); // Show quiz section

                // Reset quiz section state
                quizCompleteMessage.classList.add('hidden');
                submitAnswerButton.classList.remove('hidden');
                nextQuestionButton.classList.add('hidden');
                optionsContainer.classList.remove('pointer-events-none', 'opacity-50'); // Enable options interaction

                levelTitle.textContent = level.name;
                displayQuestion(); // Display the first question

                // Save user's current level to Firestore ONLY if Firebase is initialized
                if (firebaseInitialized) {
                    saveUserProgress(userId, level.id, currentQuestionIndex);
                }
            }

            // Function to display the current question and its options
            function displayQuestion() {
                if (currentLevel && currentQuestionIndex < currentLevel.questions.length) {
                    const q = currentLevel.questions[currentQuestionIndex];
                    questionNumberDisplay.textContent = `ጥያቄ ${currentQuestionIndex + 1} ከ ${currentLevel.questions.length}`;
                    questionDisplay.textContent = q.question;

                    // Clear previous options
                    optionsContainer.innerHTML = '';
                    selectedOption = null; // Reset selected option

                    // Shuffle options before displaying
                    const shuffledOptions = shuffleArray([...q.options]);

                    // Create and append radio buttons for each option
                    shuffledOptions.forEach((option, index) => {
                        const optionDiv = document.createElement('label');
                        optionDiv.className = 'option-item block text-gray-700 hover:bg-blue-50';
                        optionDiv.innerHTML = `
                            <input type="radio" name="quiz_option" value="${option}" class="form-radio h-5 w-5 text-blue-600">
                            <span class="ml-3 text-lg">${option}</span>
                        `;
                        optionsContainer.appendChild(optionDiv);

                        // Add event listener to each radio button to track selection
                        optionDiv.querySelector('input[type="radio"]').addEventListener('change', (event) => {
                            selectedOption = event.target.value;
                            feedbackDisplay.textContent = ''; // Clear feedback when a new option is selected
                            feedbackDisplay.className = 'text-lg mt-4 font-medium'; // Reset feedback style
                        });
                    });

                    feedbackDisplay.textContent = ''; // Clear feedback
                    feedbackDisplay.className = 'text-lg mt-4 font-medium'; // Reset feedback style
                    submitAnswerButton.classList.remove('hidden'); // Ensure submit button is visible
                    nextQuestionButton.classList.add('hidden'); // Ensure next button is hidden
                    optionsContainer.classList.remove('pointer-events-none', 'opacity-50'); // Re-enable options
                } else {
                    // Quiz is complete
                    quizCompleteMessage.classList.remove('hidden');
                    questionNumberDisplay.textContent = '';
                    questionDisplay.textContent = '';
                    optionsContainer.innerHTML = ''; // Clear options
                    submitAnswerButton.classList.add('hidden'); // Hide submit
                    nextQuestionButton.classList.add('hidden'); // Hide next
                }
            }

            // Function to handle answer submission
            submitAnswerButton.addEventListener('click', () => {
                if (!selectedOption) {
                    showModal("እባክዎ መልስ ከማስገባትዎ በፊት መልስ ይምረጡ።");
                    return;
                }

                if (currentLevel && currentQuestionIndex < currentLevel.questions.length) {
                    const correctAnswer = currentLevel.questions[currentQuestionIndex].answer;
                    // Normalize answers for comparison (case-insensitive)
                    if (selectedOption.toLowerCase() === correctAnswer.toLowerCase()) {
                        feedbackDisplay.textContent = "ትክክል ነው! በጣም ጥሩ!";
                        feedbackDisplay.className = 'text-lg mt-4 font-medium text-green-600';
                    } else {
                        feedbackDisplay.textContent = `ትክክል አይደለም። ትክክለኛው መልስ "${correctAnswer}" ነው።`;
                        feedbackDisplay.className = 'text-lg mt-4 font-medium text-red-600';
                    }
                    submitAnswerButton.classList.add('hidden'); // Hide submit
                    nextQuestionButton.classList.remove('hidden'); // Show next
                    optionsContainer.classList.add('pointer-events-none', 'opacity-50'); // Disable options after submission
                }
            });

            // Function to move to the next question
            nextQuestionButton.addEventListener('click', () => {
                currentQuestionIndex++;
                displayQuestion(); // Display the next question or quiz complete message

                // Save progress after moving to next question ONLY if Firebase is initialized
                if (firebaseInitialized && currentLevel) { // Check currentLevel to avoid saving if quiz is complete
                    saveUserProgress(userId, currentLevel.id, currentQuestionIndex);
                }
            });

            // Function to go back to the level list
            backButton.addEventListener('click', () => {
                quizSectionDiv.classList.add('hidden'); // Hide quiz section
                levelListDiv.classList.remove('hidden'); // Show level list
                quizCompleteMessage.classList.add('hidden'); // Hide quiz complete message
                optionsContainer.classList.remove('pointer-events-none', 'opacity-50'); // Ensure options are re-enabled
                currentLevel = null;
                currentQuestionIndex = 0; // Reset index for next quiz
            });

            // Initial render of levels
            renderLevels();
        }
    </script>
</body>
</html>
